<!DOCTYPE html>
<html>
<head>
    <title>AR Примерка кроссовок с распознаванием ноги</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer@3.4.0/dist/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            display: none;
        }
        model-viewer { 
            width: 100%; 
            height: 100%;
            z-index: 2;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 10;
        }
        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 3;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        button:hover {
            background: #006699;
            transform: translateY(-2px);
        }
        #ar-prompt {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 3;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" playsinline></video>
        <model-viewer
            id="viewer"
            src="models/model1.glb"
            ar
            ar-modes="webxr scene-viewer quick-look"
            camera-controls
            shadow-intensity="1"
            exposure="1">
        </model-viewer>
        
        <div id="loading">Загрузка нейросети... Подождите</div>
        <div id="ar-prompt">Наведите камеру на ногу</div>
        
        <div class="controls">
            <button id="startAR">Начать примерку</button>
            <button onclick="changeModel('models/model1.glb')">Nike Air</button>
            <button onclick="changeModel('models/model2.glb')">Adidas</button>
            <button onclick="window.Telegram.WebApp.close()">Закрыть</button>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let detector;
        let videoElement = document.getElementById('video');
        let modelViewer = document.getElementById('viewer');
        let loadingElement = document.getElementById('loading');
        let arPrompt = document.getElementById('ar-prompt');
        let isARActive = false;

        // Инициализация TensorFlow и детектора позы
        async function initPoseDetection() {
            await tf.ready();
            const model = poseDetection.SupportedModels.MoveNet;
            const detectorConfig = {
                modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER,
                enableSmoothing: true
            };
            detector = await poseDetection.createDetector(model, detectorConfig);
            loadingElement.style.display = 'none';
        }

        // Запуск камеры
        async function setupCamera() {
            videoElement.style.display = 'block';
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });
            videoElement.srcObject = stream;
            return new Promise((resolve) => {
                videoElement.onloadedmetadata = () => {
                    resolve(videoElement);
                };
            });
        }

        // Обнаружение позы и позиционирование 3D модели
        async function detectPose() {
            if (!isARActive) return;
            
            const poses = await detector.estimatePoses(videoElement);
            if (poses.length > 0) {
                const pose = poses[0];
                // Находим ключевые точки ноги (примерно)
                const ankleLeft = pose.keypoints.find(k => k.name === 'left_ankle');
                const ankleRight = pose.keypoints.find(k => k.name === 'right_ankle');
                
                if (ankleLeft && ankleLeft.score > 0.3) {
                    positionSneaker(ankleLeft);
                } else if (ankleRight && ankleRight.score > 0.3) {
                    positionSneaker(ankleRight);
                }
            }
            requestAnimationFrame(detectPose);
        }

        // Позиционирование кроссовка относительно ноги
        function positionSneaker(ankle) {
            // Преобразование координат для Model Viewer
            const x = (ankle.x / videoElement.videoWidth) * 100 - 50;
            const y = -(ankle.y / videoElement.videoHeight) * 100 + 50;
            
            // Обновление позиции модели
            modelViewer.modelTransform = {
                translation: { x, y, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: '0.3 0.3 0.3'
            };
        }

        // Запуск AR-примерки
        document.getElementById('startAR').addEventListener('click', async () => {
            try {
                await setupCamera();
                await initPoseDetection();
                isARActive = true;
                detectPose();
                arPrompt.textContent = "Двигайте ногой для точной примерки";
            } catch (error) {
                console.error("Ошибка:", error);
                alert("Не удалось запустить камеру. Проверьте разрешения.");
            }
        });

        // Смена модели
        function changeModel(modelUrl) {
            document.getElementById('viewer').src = modelUrl;
        }

        // Интеграция с Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();
        }
    </script>
</body>
</html>
